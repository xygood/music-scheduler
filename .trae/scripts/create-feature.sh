#!/bin/bash

# Spec-Kit åŠŸèƒ½åˆå§‹åŒ–è„šæœ¬
# ç”¨æ³•: ./create-feature.sh <åŠŸèƒ½åç§°> [åŠŸèƒ½æè¿°]

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# å¸®åŠ©ä¿¡æ¯
show_help() {
    echo "Spec-Kit åŠŸèƒ½åˆå§‹åŒ–è„šæœ¬"
    echo ""
    echo "ç”¨æ³•:"
    echo "  ./create-feature.sh <åŠŸèƒ½åç§°> [åŠŸèƒ½æè¿°]"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  ./create-feature.sh \"user-auth\" \"ç”¨æˆ·ç™»å½•è®¤è¯åŠŸèƒ½\""
    echo "  ./create-feature.sh \"payment-integration\""
    echo ""
    echo "é€‰é¡¹:"
    echo "  -h, --help     æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    echo "  -l, --list     åˆ—å‡ºæ‰€æœ‰å·²æœ‰åŠŸèƒ½"
}

# åˆ—å‡ºå·²æœ‰åŠŸèƒ½
list_features() {
    if [ -d "specs" ]; then
        echo -e "${BLUE}å·²æœ‰åŠŸèƒ½åˆ—è¡¨:${NC}"
        ls -1 specs/ | grep -E '^[0-9]+-' | sort -t'-' -k1 -n || echo "  (æš‚æ— )"
    else
        echo -e "${YELLOW}specs ç›®å½•ä¸å­˜åœ¨${NC}"
    fi
}

# å‚æ•°è§£æ
if [ $# -eq 0 ] || [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
    show_help
    exit 0
fi

if [ "$1" == "-l" ] || [ "$1" == "--list" ]; then
    list_features
    exit 0
fi

FEATURE_NAME="$1"
FEATURE_DESC="${2:-$FEATURE_NAME}"

# è·å–å½“å‰æ—¥æœŸ
DATE=$(date +%Y-%m-%d)

# æŸ¥æ‰¾ä¸‹ä¸€ä¸ªç¼–å·
get_next_number() {
    local max_num=0
    if [ -d "specs" ]; then
        for dir in specs/[0-9]*-*/; do
            if [ -d "$dir" ]; then
                local num=$(basename "$dir" | grep -oE '^[0-9]+')
                if [ "$num" -gt "$max_num" ]; then
                    max_num=$num
                fi
            fi
        done
    fi
    echo $((max_num + 1))
}

NEXT_NUM=$(get_next_number)
FEATURE_DIR="specs/$(printf "%03d" $NEXT_NUM)-${FEATURE_NAME}"

echo -e "${BLUE}================================${NC}"
echo -e "${BLUE}  Spec-Kit åŠŸèƒ½åˆå§‹åŒ–${NC}"
echo -e "${BLUE}================================${NC}"
echo ""

# æ£€æŸ¥ specs ç›®å½•
if [ ! -d "specs" ]; then
    echo -e "${YELLOW}åˆ›å»º specs ç›®å½•...${NC}"
    mkdir -p specs
fi

# æ£€æŸ¥åŠŸèƒ½ç›®å½•æ˜¯å¦å·²å­˜åœ¨
if [ -d "$FEATURE_DIR" ]; then
    echo -e "${RED}é”™è¯¯: åŠŸèƒ½ç›®å½•å·²å­˜åœ¨: $FEATURE_DIR${NC}"
    exit 1
fi

# åˆ›å»ºåŠŸèƒ½ç›®å½•
echo -e "${BLUE}åˆ›å»ºåŠŸèƒ½ç›®å½•: $FEATURE_DIR${NC}"
mkdir -p "$FEATURE_DIR"

# åˆ›å»º spec.md
cat > "$FEATURE_DIR/001-spec.md" << EOF
# éœ€æ±‚è§„æ ¼æ–‡æ¡£: ${FEATURE_NAME}

## åŸºæœ¬ä¿¡æ¯
- **åŠŸèƒ½åç§°**: ${FEATURE_NAME}
- **åŠŸèƒ½æè¿°**: ${FEATURE_DESC}
- **ç‰ˆæœ¬**: 1.0.0
- **åˆ›å»ºæ—¥æœŸ**: ${DATE}
- **çŠ¶æ€**: ğŸ“ è‰ç¨¿

## ç”¨æˆ·æ•…äº‹
ä½œä¸º [ç”¨æˆ·è§’è‰²]ï¼Œ
æˆ‘å¸Œæœ› [åŠŸèƒ½æè¿°]ï¼Œ
ä»¥ä¾¿ [å®ç°ä»·å€¼]ã€‚

## åŠŸèƒ½èŒƒå›´

### åŒ…å«åŠŸèƒ½ (In Scope)
1. [åŠŸèƒ½ç‚¹ 1]
2. [åŠŸèƒ½ç‚¹ 2]
3. [åŠŸèƒ½ç‚¹ 3]

### ä¸åŒ…å«åŠŸèƒ½ (Out of Scope)
1. [æ’é™¤çš„åŠŸèƒ½ 1]
2. [æ’é™¤çš„åŠŸèƒ½ 2]

## éªŒæ”¶æ ‡å‡†

### å¿…é¡»æ»¡è¶³ (Must Have)
- [ ] [éªŒæ”¶æ ‡å‡† 1]
- [ ] [éªŒæ”¶æ ‡å‡† 2]
- [ ] [éªŒæ”¶æ ‡å‡† 3]

### æœ€å¥½æ»¡è¶³ (Nice to Have)
- [ ] [å¯é€‰æ ‡å‡† 1]
- [ ] [å¯é€‰æ ‡å‡† 2]

## æŠ€æœ¯çº¦æŸ
- [çº¦æŸ 1: å¦‚æŠ€æœ¯æ ˆã€æ€§èƒ½è¦æ±‚ç­‰]
- [çº¦æŸ 2: å¦‚å…¼å®¹æ€§è¦æ±‚ç­‰]

## ç›¸å…³æ–‡æ¡£
- [é“¾æ¥åˆ°å…¶ä»–ç›¸å…³æ–‡æ¡£]

---
**æœ€åæ›´æ–°**: ${DATE}
EOF

# åˆ›å»º plan.md
cat > "$FEATURE_DIR/001-plan.md" << EOF
# æŠ€æœ¯æ–¹æ¡ˆ: ${FEATURE_NAME}

## åŸºæœ¬ä¿¡æ¯
- **åŠŸèƒ½åç§°**: ${FEATURE_NAME}
- **ç‰ˆæœ¬**: 1.0.0
- **åˆ›å»ºæ—¥æœŸ**: ${DATE}
- **å…³è”éœ€æ±‚**: [001-spec.md]
- **çŠ¶æ€**: ğŸ“ è‰ç¨¿

## æŠ€æœ¯æ–¹æ¡ˆæ¦‚è¿°
[ç®€è¦æè¿°æŠ€æœ¯å®ç°æ–¹æ¡ˆ]

## æ¶æ„è®¾è®¡

### æ•°æ®æ¨¡å‹
\`\`\`typescript
// å®šä¹‰æ ¸å¿ƒæ•°æ®ç»“æ„å’Œç±»å‹
\`\`\`

### ç»„ä»¶ç»“æ„
\`\`\`
[ç»„ä»¶å±‚çº§å›¾æˆ–æè¿°]
\`\`\`

### API è®¾è®¡
| æ–¹æ³• | è·¯å¾„ | æè¿° | è¯·æ±‚å‚æ•° | å“åº” |
|------|------|------|----------|------|
| GET | /api/xxx | æè¿° | { } | { } |

## å®ç°æ­¥éª¤

### é˜¶æ®µ 1: [é˜¶æ®µåç§°]
- [ ] ä»»åŠ¡ 1
- [ ] ä»»åŠ¡ 2

### é˜¶æ®µ 2: [é˜¶æ®µåç§°]
- [ ] ä»»åŠ¡ 1
- [ ] ä»»åŠ¡ 2

## æŠ€æœ¯å†³ç­–

### å†³ç­– 1: [å†³ç­–ä¸»é¢˜]
**é€‰æ‹©**: [é€‰é¡¹ A]
**åŸå› **: [è§£é‡Šä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªæ–¹æ¡ˆ]

## é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | å¯èƒ½æ€§ | ç¼“è§£æªæ–½ |
|------|------|--------|----------|
| [é£é™©æè¿°] | é«˜/ä¸­/ä½ | é«˜/ä¸­/ä½ | [æªæ–½] |

---
**æœ€åæ›´æ–°**: ${DATE}
EOF

# åˆ›å»º tasks.md
cat > "$FEATURE_DIR/001-tasks.md" << EOF
# ä»»åŠ¡æ¸…å•: ${FEATURE_NAME}

## åŸºæœ¬ä¿¡æ¯
- **åŠŸèƒ½åç§°**: ${FEATURE_NAME}
- **ç‰ˆæœ¬**: 1.0.0
- **åˆ›å»ºæ—¥æœŸ**: ${DATE}
- **å…³è”æ–‡æ¡£**:
  - éœ€æ±‚è§„æ ¼: [001-spec.md]
  - æŠ€æœ¯æ–¹æ¡ˆ: [001-plan.md]
- **çŠ¶æ€**: ğŸ“ å¾…å¼€å§‹

## ä»»åŠ¡åˆ—è¡¨

### T001: [ä»»åŠ¡æ ‡é¢˜]
- **æè¿°**: [ä»»åŠ¡è¯¦ç»†æè¿°]
- **ä¼˜å…ˆçº§**: é«˜
- **çŠ¶æ€**: â¬œ å¾…å¼€å§‹
- **éªŒæ”¶æ ‡å‡†**:
  - [ ] [æ ‡å‡† 1]
  - [ ] [æ ‡å‡† 2]

### T002: [ä»»åŠ¡æ ‡é¢˜]
- **æè¿°**: [ä»»åŠ¡è¯¦ç»†æè¿°]
- **ä¼˜å…ˆçº§**: ä¸­
- **çŠ¶æ€**: â¬œ å¾…å¼€å§‹
- **éªŒæ”¶æ ‡å‡†**:
  - [ ] [æ ‡å‡† 1]
  - [ ] [æ ‡å‡† 2]

### T003: [ä»»åŠ¡æ ‡é¢˜]
- **æè¿°**: [ä»»åŠ¡è¯¦ç»†æè¿°]
- **ä¼˜å…ˆçº§**: ä½
- **çŠ¶æ€**: â¬œ å¾…å¼€å§‹
- **éªŒæ”¶æ ‡å‡†**:
  - [ ] [æ ‡å‡† 1]
  - [ ] [æ ‡å‡† 2]

## è¿›åº¦è¿½è¸ª

| ä»»åŠ¡ | çŠ¶æ€ | å¼€å§‹æ—¶é—´ | å®Œæˆæ—¶é—´ | å¤‡æ³¨ |
|------|------|----------|----------|------|
| T001 | â¬œ | - | - | - |
| T002 | â¬œ | - | - | - |
| T003 | â¬œ | - | - | - |

---
**æœ€åæ›´æ–°**: ${DATE}
EOF

# åˆ›å»º checklist.md
cat > "$FEATURE_DIR/checklist.md" << EOF
# è´¨é‡æ£€æŸ¥æ¸…å•: ${FEATURE_NAME}

## éœ€æ±‚è§„æ ¼æ£€æŸ¥

### å†…å®¹å®Œæ•´æ€§
- [ ] ç”¨æˆ·æ•…äº‹æ¸…æ™°æ˜ç¡®
- [ ] åŠŸèƒ½èŒƒå›´å®šä¹‰æ¸…æ¥šï¼ˆåŒ…å«/ä¸åŒ…å«ï¼‰
- [ ] éªŒæ”¶æ ‡å‡†å¯æµ‹è¯•ã€å¯éªŒè¯
- [ ] æŠ€æœ¯çº¦æŸå·²åˆ—å‡º

### è´¨é‡è¦æ±‚
- [ ] æ²¡æœ‰ [å¾…æ¾„æ¸…] æ ‡è®°
- [ ] éœ€æ±‚æè¿°æ— æ­§ä¹‰
- [ ] éªŒæ”¶æ ‡å‡†å¯é‡åŒ–

## æŠ€æœ¯æ–¹æ¡ˆæ£€æŸ¥

### è®¾è®¡è´¨é‡
- [ ] æ•°æ®æ¨¡å‹å®šä¹‰æ¸…æ™°
- [ ] æ¥å£è®¾è®¡å®Œæ•´
- [ ] æŠ€æœ¯å†³ç­–æœ‰ä¾æ®
- [ ] é£é™©å·²è¯†åˆ«å¹¶æœ‰ç¼“è§£æªæ–½

### å¯è¡Œæ€§
- [ ] æ–¹æ¡ˆç¬¦åˆæŠ€æœ¯çº¦æŸ
- [ ] å®ç°æ­¥éª¤å¯æ‰§è¡Œ
- [ ] å·¥ä½œé‡è¯„ä¼°åˆç†

## ä»»åŠ¡æ¸…å•æ£€æŸ¥

### ä»»åŠ¡åˆ†è§£
- [ ] ä»»åŠ¡ç²’åº¦é€‚ä¸­ï¼ˆ4-8å°æ—¶ï¼‰
- [ ] ä»»åŠ¡é—´ä¾èµ–å…³ç³»æ¸…æ™°
- [ ] æ¯ä¸ªä»»åŠ¡æœ‰æ˜ç¡®éªŒæ”¶æ ‡å‡†
- [ ] ä¼˜å…ˆçº§åˆ’åˆ†åˆç†

## ä»£ç å®ç°æ£€æŸ¥

### åŠŸèƒ½å®Œæ•´æ€§
- [ ] æ‰€æœ‰ Must Have éªŒæ”¶æ ‡å‡†å·²å®ç°
- [ ] åŠŸèƒ½ç¬¦åˆéœ€æ±‚è§„æ ¼
- [ ] è¾¹ç•Œæƒ…å†µå·²å¤„ç†

### ğŸ›¡ï¸ ä»£ç ä¿æŠ¤æ£€æŸ¥ï¼ˆå…³é”®ï¼‰
- [ ] **å›å½’æµ‹è¯•é€šè¿‡**: æ‰€æœ‰å·²æœ‰æµ‹è¯•ä»ç„¶é€šè¿‡
- [ ] **æ–°åŠŸèƒ½æœ‰æµ‹è¯•**: æ–°åŠŸèƒ½æœ‰å•å…ƒæµ‹è¯•è¦†ç›–
- [ ] **é›†æˆæµ‹è¯•**: å…³é”®è·¯å¾„æœ‰é›†æˆæµ‹è¯•
- [ ] **å½±å“è¯„ä¼°**: ç¡®è®¤æ²¡æœ‰ç ´åå·²æœ‰åŠŸèƒ½
- [ ] **å…¼å®¹æ€§æ£€æŸ¥**: æ¥å£/æ•°æ®ä¿æŒå‘åå…¼å®¹

### ä»£ç è´¨é‡
- [ ] ä»£ç é€šè¿‡é™æ€æ£€æŸ¥ (lint)
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] æ ¸å¿ƒåŠŸèƒ½æœ‰å•å…ƒæµ‹è¯•
- [ ] ä»£ç è‡ªè§£é‡Šï¼Œæ³¨é‡Šè¯´æ˜"ä¸ºä»€ä¹ˆ"

### æ–‡æ¡£åŒæ­¥
- [ ] ä»£ç ä¸æ–‡æ¡£ä¿æŒä¸€è‡´
- [ ] æ›´æ–°ä»»åŠ¡æ¸…å•çŠ¶æ€
- [ ] è®°å½•å·²çŸ¥é—®é¢˜å’Œ TODO

---
**æ£€æŸ¥æ—¥æœŸ**: 
**æ£€æŸ¥ç»“æœ**: â¬œ é€šè¿‡ / â¬œ éœ€ä¿®æ”¹
**æ£€æŸ¥äºº**: 
EOF

echo ""
echo -e "${GREEN}âœ… åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ!${NC}"
echo ""
echo -e "${BLUE}åˆ›å»ºçš„æ–‡ä»¶:${NC}"
echo "  ğŸ“„ $FEATURE_DIR/001-spec.md   (éœ€æ±‚è§„æ ¼)"
echo "  ğŸ“„ $FEATURE_DIR/001-plan.md   (æŠ€æœ¯æ–¹æ¡ˆ)"
echo "  ğŸ“„ $FEATURE_DIR/001-tasks.md  (ä»»åŠ¡æ¸…å•)"
echo "  ğŸ“„ $FEATURE_DIR/checklist.md  (è´¨é‡æ£€æŸ¥)"
echo ""
echo -e "${BLUE}ä¸‹ä¸€æ­¥:${NC}"
echo "  1. ç¼–è¾‘ 001-spec.md å®Œå–„éœ€æ±‚"
echo "  2. è¿è¡Œ ./.trae/scripts/validate-spec.sh $FEATURE_DIR æ£€æŸ¥æ–‡æ¡£è´¨é‡"
echo "  3. å®Œæˆåå¼€å§‹æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡"
